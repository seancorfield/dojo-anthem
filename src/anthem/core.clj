(ns anthem.core
  (:use overtone.core))

(definst sin-wave [freq 440 attack 0.01 sustain 0.4 release 0.1 vol 0.4] 
  (* (env-gen (lin-env attack sustain release) 1 1 0 1 FREE)
     (sin-osc freq)
     vol))

(definst saw-wave [freq 440 attack 0.01 sustain 0.4 release 0.1 vol 0.4] 
  (* (env-gen (lin-env attack sustain release) 1 1 0 1 FREE)
     (saw freq)
     vol))

(defn play-note [music-note length m]
  (saw-wave (midi->hz (note music-note))
            0.01
            (-> (metro-tick m)
                (/ 1000.0)
                (* length)
                (- 0.11))))

(defonce metro (metronome 120))

(defn melody-beat [melody m beat-num]
  (when (seq melody)
    (do (let [[note length] (first melody)]
          (when note
            (at (m beat-num) (play-note note length m)))
         (recur (rest melody) m (+ length beat-num))))))


(def durations
  {:16 0.25
   :8  0.5
   :8. 0.75
   :4  1
   :4. 1.5
   :2  2
   :2. 3
   :1  4})

(defn preprocess
  [notes]
  (loop [notes notes
         q (transient [])]
    (if-let [[f d] (first notes)]
      (let [tup [f (d durations)]]
        (recur (rest notes) (conj! q tup)))
      (persistent! q))))

(defn play-melody [melody]
  (melody-beat (preprocess melody) metro (metro)))

(def national
[[:g5 :8.]
 [:e5 :16]
 [:c5 :4]
 [:e5 :4]
 [:g5 :4]
 [:c6 :2]
 [:e6 :8.]
 [:d6 :16]
 [:c6 :4]
 [:e5 :4]
 [:f#5 :4]
 [:g5 :2]
 [:g5 :8]
 [:g5 :8]
 [:e6 :4.]
 [:d6 :8]
 [:c6 :4]
 [:b5 :2]
 [:a5 :8]
 [:b5 :8]
 [:c6 :4]
 [:c6 :4]
 [:g5 :4]
 [:e5 :4]
 [:c5 :8]
 [nil :8]
 [:g5 :8.]
 [:e5 :16]
 [:c5 :4]
 [:e5 :4]
 [:g5 :4]
 [:c6 :2]
 [:e6 :8.]
 [:d6 :16]
 [:c6 :4]
 [:e5 :4]
 [:f#5 :4]
 [:g5 :2]
 [:g5 :8]
 [:g5 :8]
 [:e6 :4.]
 [:d6 :8]
 [:c6 :4]
 [:b5 :2]
 [:a5 :8]
 [:b5 :8]
 [:c6 :4]
 [:c6 :4]
 [:g5 :4]
 [:e5 :4]
 [:c5 :8]
 [nil :8]
 [:e6 :8]
 [:e6 :8]
 [:e6 :4]
 [:f6 :4]
 [:g6 :4]
 [:g6 :2]
 [:f6 :8]
 [:e6 :8]
 [:d6 :4]
 [:e6 :4]
 [:f6 :4]
 [:f6 :2]
 [:f6 :4]
 [:e6 :4.]
 [:d6 :8]
 [:c6 :4]
 [:b5 :2]
 [:a5 :8]
 [:b5 :8]
 [:c6 :4]
 [:e5 :4]
 [:f#5 :4]
 [:g5 :4.]
 [nil :8]
 [:g5 :4]
 [:c6 :4]
 [:c6 :4]
 [:c6 :8]
 [:b5 :8]
 [:a5 :4]
 [:a5 :4]
 [:a5 :4]
 [:d6 :4]
 [:f6 :8]
 [:e6 :8]
 [:d6 :8]
 [:c6 :8]
 [:c6 :4]
 [:b5 :2]
 [:g5 :8]
 [:g5 :8]
 [:c6 :4.]
 [:d6 :8]
 [:e6 :4]
 [:f6 :4]
 [:g6 :2.]
 [:c7 :16]
 [:b6 :16]
 [:c7 :16]
 [:b6 :16]
 [:c7 :2]
 [nil :4.]
 [:c6 :8]
 [:d6 :8]
 [:e6 :4.]
 [:f6 :8]
 [:d6 :4]
 [:c6 :2]]
)

(def national-lower
  [[:g4 :8.]
 [:e4 :16]
 [:c4 :4]
 [:e4 :4]
 [:g4 :4]
 [:c5 :2]
 [:e5 :8.]
 [:d5 :16]
 [:c5 :4]
 [:e4 :4]
 [:f#4 :4]
 [:g4 :2]
 [:g4 :8]
 [:g4 :8]
 [:e5 :4.]
 [:d5 :8]
 [:c5 :4]
 [:b4 :2]
 [:a4 :8]
 [:b4 :8]
 [:c5 :4]
 [:c5 :4]
 [:g4 :4]
 [:e4 :4]
 [:c4 :8]
 [nil :8]
 [:g4 :8.]
 [:e4 :16]
 [:c4 :4]
 [:e4 :4]
 [:g4 :4]
 [:c5 :2]
 [:e5 :8.]
 [:d5 :16]
 [:c5 :4]
 [:e4 :4]
 [:f#4 :4]
 [:g4 :2]
 [:g4 :8]
 [:g4 :8]
 [:e5 :4.]
 [:d5 :8]
 [:c5 :4]
 [:b4 :2]
 [:a4 :8]
 [:b4 :8]
 [:c5 :4]
 [:c5 :4]
 [:g4 :4]
 [:e4 :4]
 [:c4 :8]
 [nil :8]
 [:e5 :8]
 [:e5 :8]
 [:e5 :4]
 [:f5 :4]
 [:g5 :4]
 [:g5 :2]
 [:f5 :8]
 [:e5 :8]
 [:d5 :4]
 [:e5 :4]
 [:f5 :4]
 [:f5 :2]
 [:f5 :4]
 [:e5 :4.]
 [:d5 :8]
 [:c5 :4]
 [:b4 :2]
 [:a4 :8]
 [:b4 :8]
 [:c5 :4]
 [:e4 :4]
 [:f#4 :4]
 [:g4 :4.]
 [nil :8]
 [:g4 :4]
 [:c5 :4]
 [:c5 :4]
 [:c5 :8]
 [:b4 :8]
 [:a4 :4]
 [:a4 :4]
 [:a4 :4]
 [:d5 :4]
 [:f5 :8]
 [:e5 :8]
 [:d5 :8]
 [:c5 :8]
 [:c5 :4]
 [:b4 :2]
 [:g4 :8]
 [:g4 :8]
 [:c5 :4.]
 [:d5 :8]
 [:e5 :4]
 [:f5 :4]
 [:g5 :2.]
 [:c6 :16]
 [:b5 :16]
 [:c6 :16]
 [:b5 :16]
 [:c6 :2]
 [nil :4.]
 [:c5 :8]
 [:d5 :8]
 [:e5 :4.]
 [:f5 :8]
 [:d5 :4]
 [:c5 :2]]

  )

(def national-short
  [[:g5 :8.]
   [:e5 :16]
   [:c5 :4]
   [:e5 :4]
   [:g5 :4]
   [:c6 :2]
   [:e6 :8.]
   [:d6 :16]
   [:c6 :4]
   [:e5 :4]
   [:f#5 :4]
   [:g5 :2]
   [:g5 :8]
   [:g5 :8]
   [:e6 :4.]
   [:d6 :8]
   [:c6 :4]
   [:b5 :2]
   [:a5 :8]
   [:a5 :8]
   [:c6 :4]
   [:c6 :4]
   [:g5 :4]
   [:e5 :4]
   [:c5 :8]
   [nil :8]
   [:g5 :8.]
   [:e5 :16]
   [:c5 :4]
   [:e5 :4]
   [:g5 :4]
   [:c6 :2]
   [:e6 :8.]
   [:d6 :16]
   [:c6 :4]
   [:e5 :4]
   [:f#5 :4]
   [:g5 :2]])
